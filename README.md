# Tawq Impact Platform

منصة خلفية (Backend) أولية مبنية بـ [FastAPI](https://fastapi.tiangolo.com/) لإدارة فرق التسويق للجمعيات الخيرية في السعودية. توفر النظام عدة وحدات تشمل الحسابات المتعددة، إدارة المشاريع والمهام، التحليلات اللحظية، ولوحة المتصدرين مع توصيات ذكية لتحسين الأداء.

## المتطلبات

- Python 3.11+
- بيئة افتراضية مفعلة

## التثبيت والتشغيل

```bash
pip install -r requirements.txt
uvicorn app.main:app --reload
```

سيعمل الخادم افتراضيًا على `http://127.0.0.1:8000` مع وثائق تلقائية عبر Swagger في `/docs`.

### كيفية استعراض البرنامج

> **ملاحظة:** لا يتضمن هذا المستودع واجهة أمامية. يتم التفاعل عبر واجهة برمجة التطبيقات (API) إما من خلال Swagger UI أو عبر أدوات مثل `curl` وPostman.

#### 1. تشغيل الخادم وفتح الوثائق

بعد تنفيذ أوامر التشغيل أعلاه:

- افتح المتصفح وتوجه إلى:
  - واجهة برمجة التطبيقات التفاعلية (Swagger UI): `http://127.0.0.1:8000/docs`
  - واجهة Redoc التوثيقية: `http://127.0.0.1:8000/redoc`
- من داخل Swagger UI اضغط زر **Authorize** أعلى اليمين لإضافة رمز الوصول (سيتم توليده في الخطوات اللاحقة) حتى تتمكن من تجربة نقاط النهاية المحمية.

#### 2. إنشاء الحساب الإداري الأول

يمكن إنشاء أول مستخدم (مثل المدير) عبر طلب `POST` إلى `/auth/register`.

مثال باستخدام `curl`:

```bash
curl -X POST http://127.0.0.1:8000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
        "email": "admin@example.com",
        "password": "ChangeMe123!",
        "full_name": "مدير النظام",
        "role": "admin"
      }'
```

يمكن تكرار العملية مع أدوار أخرى (`employee`, `supervisor`, `accountant`) لإنشاء بقية الحسابات. يقوم النظام آليًا بتهيئة ملفات التعريف الخاصة بالموظفين أو المشرفين عند الحاجة.

#### 3. تسجيل الدخول والحصول على رمز الوصول

بعد إنشاء الحساب، أرسل طلب `POST` إلى `/auth/token` باستخدام بيانات الاعتماد ذاتها للحصول على رمز JWT صالح لمدة ساعة افتراضيًا:

```bash
curl -X POST http://127.0.0.1:8000/auth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=ChangeMe123!"
```

سيعيد الخادم استجابة مشابهة للتالي:

```json
{
  "access_token": "<رمز طويل>",
  "token_type": "bearer"
}
```

انسخ قيمة `access_token` واستخدمها في Swagger UI عبر زر **Authorize** أو أضفها يدويًا في ترويسة الطلبات:

```
Authorization: Bearer <access_token>
```

#### 4. تجربة الوحدات المختلفة

مع تفعيل التفويض يمكنك الآن استعراض بقية النقاط:

- **المشاريع:** إنشاء مشروع جديد عبر `/projects/` ثم ربطه بالموظفين.
- **المهام:** إضافة المهام اليومية، تحديد الأولويات، وتسجيل الإيراد عبر `/tasks/logs/`.
- **لوحة المتصدرين والتحليلات:** قراءة نتائج `/analytics/leaderboard` و`/analytics/insights` لمتابعة الأداء اللحظي.
- **الحسابات:** تعديل الصلاحيات أو تعطيل المستخدمين من خلال `/users/{user_id}`.

#### 5. سيناريو استخدام متكامل خطوة بخطوة

يعرض المثال التالي سلسلة طلبات متتابعة تغطي أهم الوحدات. يمكن تنفيذها من خلال Swagger UI أو عبر `curl` أو Postman.

1. **إنشاء مشروع جديد**

   ```bash
   curl -X POST http://127.0.0.1:8000/projects/ \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
           "name": "حملة رمضان",
           "description": "حملة تستهدف المتبرعين الكرام خلال شهر رمضان",
           "target_amount": 100000,
           "start_date": "2024-03-01",
           "end_date": "2024-04-15"
         }'
   ```

   سيعيد الخادم معرف المشروع (`id`) الذي سيُستخدم في الطلبات اللاحقة.

2. **تعيين موظفين ومشرف للمشروع**

   ```bash
   curl -X POST http://127.0.0.1:8000/projects/<project_id>/assignments \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
           "supervisor_ids": ["<supervisor_id>"],
           "employee_ids": ["<employee_id_1>", "<employee_id_2>"]
         }'
   ```

   يمكن الحصول على معرفات المستخدمين عبر استدعاء `/users/` أو من استجابة التسجيل.

3. **إضافة مهمة للموظفين**

   ```bash
   curl -X POST http://127.0.0.1:8000/tasks/ \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
           "project_id": "<project_id>",
           "title": "التواصل مع 50 متبرعًا من الفئة الذهبية",
           "description": "اتصل وتابع المتبرعين الذين تبرعوا بأكثر من 1000 ريال",
           "priority": 1,
           "due_date": "2024-03-05",
           "assigned_employee_ids": ["<employee_id_1>"]
         }'
   ```

   يتيح النظام إسناد أكثر من موظف للمهمة ذاتها عند الحاجة.

4. **تسجيل تقدم الموظف وإيراد المهمة**

   ```bash
   curl -X POST http://127.0.0.1:8000/tasks/logs/ \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
           "task_id": "<task_id>",
           "employee_id": "<employee_id_1>",
           "status": "in_progress",
           "revenue": 15000,
           "expenses": 1200,
           "notes": "تم التواصل مع 15 متبرعًا وتم إغلاق 5 تبرعات"
         }'
   ```

   يتم تحديث نقاط الموظف تلقائيًا بناءً على الإنجاز والإيراد المرتبط.

5. **مراجعة لوحة المتصدرين اليومية**

   ```bash
   curl -X GET http://127.0.0.1:8000/analytics/leaderboard?period=daily \
     -H "Authorization: Bearer <token>"
   ```

   تُظهر الاستجابة أفضل الموظفين مع نقاطهم وإيراداتهم وعدد المهام المنجزة.

6. **تحليل الأداء واقتراحات التحسين**

   ```bash
   curl -X GET http://127.0.0.1:8000/analytics/insights?project_id=<project_id> \
     -H "Authorization: Bearer <token>"
   ```

   يتضمن التحليل التوقعات الأسبوعية، وتتبع العوائق المتكررة، وتوصيات شخصية للموظفين.

7. **استخراج البيانات للأرشفة أو المتابعة**

   ```bash
   curl -X GET "http://127.0.0.1:8000/analytics/export?project_id=<project_id>&format=csv" \
     -H "Authorization: Bearer <token>" -o project-report.csv
   ```

   يتم حفظ تقرير CSV محليًا يمكن تحميله إلى نظم التحليل أو التخزين السحابي.

> **نصيحة:** عند استخدام Swagger UI يمكنك الضغط على زر **Try it out** لكل نقطة نهاية ثم تعبئة الحقول يدويًا لتوليد الطلب واستعراض الاستجابة مباشرة.

كل نقطة نهاية موثقة داخل Swagger UI مع الحقول المطلوبة والاستجابة المتوقعة.

#### 6. توصيات للنشر أو العرض التجريبي

- لتقديم عرض توضيحي داخلي يمكنك إنشاء مجموعة حسابات اختبار ثم مشاركة روابط Swagger UI مع الفريق.
- في بيئة الإنتاج يفضل تشغيل الخادم باستخدام [Uvicorn مع Gunicorn](https://www.uvicorn.org/deployment/#gunicorn) أو أي مزود ASGI آخر، مع إعداد HTTPS وطبقة مصادقة خارجية إذا لزم الأمر.
- عند ربط واجهة أمامية لاحقًا، يمكنها استخدام نفس نقاط النهاية مع ترويسة التفويض المذكورة أعلاه.

### الإعداد مع Supabase

للاستفادة من قاعدة بيانات Supabase وخدماتها، عرِّف المتغيرات البيئية التالية قبل تشغيل الخادم:

```bash
export SUPABASE_URL="https://<project>.supabase.co"
export SUPABASE_SERVICE_ROLE_KEY="<service-role-key>"
export SUPABASE_DB_URL="postgresql+psycopg://<user>:<password>@db.<project>.supabase.co:5432/postgres"
```

- إذا كنت تفضّل استخدام مفتاح واجهة البرمجة العمومية فبإمكانك استخدام `SUPABASE_ANON_KEY` بدلًا من `SUPABASE_SERVICE_ROLE_KEY` وفقًا للصلاحيات المطلوبة.
- بمجرد توفر `SUPABASE_DB_URL` سيستخدم التطبيق قاعدة بيانات Supabase تلقائيًا، مع تفعيل اتصال آمن (`sslmode=require`).
- عند عدم تعريف القيم أعلاه سيستمر التطبيق في استخدام قاعدة بيانات SQLite المحلية (`tawq.db`).
- للتحقق من أن التطبيق متصل بقاعدة Supabase يمكنك:
  1. تشغيل الخادم ثم متابعة السجلات (logs) وسترى عنوان قاعدة البيانات المستخدم.
  2. أو استدعاء نقطة `/analytics/healthcheck` (إذا كانت مفعَّلة) للتحقق من الحالة، أو تنفيذ استعلام بسيط مثل `GET /projects/` والتأكد من أن البيانات تُحفظ في واجهة Supabase مباشرة.
  3. ضمن لوحة Supabase يمكن فتح تبويب **Table editor** لمشاهدة الجداول التي أنشأها التطبيق (`users`, `projects`, `tasks`...).

#### تهيئة الجداول عبر Supabase CLI (اختياري)

في حال رغبتك باستيراد المخطط يدويًا أو تشغيل الأوامر عبر واجهة Supabase CLI:

```bash
supabase db connect --password <database-password>
supabase db push
```

يسمح ذلك بتطبيق أي تعديلات على المخطط مباشرة على قاعدة البيانات السحابية قبل تشغيل التطبيق في بيئة الإنتاج.


## الاختبارات

```bash
pytest
```

> **ملاحظة:** في البيئات المغلقة قد يتعذر تنزيل الاعتماديات عبر `pip`. في هذه الحالة يجب توفير الحزم المطلوبة مسبقًا أو استخدام مرآة داخلية.

## لمحة عن الوظائف الرئيسية

- **نظام الصلاحيات:** حسابات للمدير، المشرف، المحاسب، والموظف مع تفعيل وتعطيل الحسابات.
- **إدارة المشاريع:** إنشاء المشاريع، تعيين الموظفين، وتتبع الإيرادات والمصروفات.
- **إدارة المهام:** إنشاء المهام، تعيين الأولويات، تسجيل السجلات اليومية، ورصد الإيرادات لكل مهمة.
- **لوحة المتصدرين:** نقاط، إيرادات، والمهام المكتملة مع توصيات ذكية مبنية على البيانات الحديثة.
- **رؤى الموظفين:** تحليلات أسبوعية للنشاط، العوائق المتكررة، والتوصيات الشخصية.

هذا الإصدار يمثل أساسًا يمكن توسيعه لاحقًا ليشمل بقية المتطلبات مثل الجدولة الذكية، الأتمتة، ونظام التدريب المتكامل.
