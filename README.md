# Tawq Impact Platform

منصة خلفية (Backend) أولية مبنية بـ [FastAPI](https://fastapi.tiangolo.com/) لإدارة فرق التسويق للجمعيات الخيرية في السعودية. توفر النظام عدة وحدات تشمل الحسابات المتعددة، إدارة المشاريع والمهام، التحليلات اللحظية، ولوحة المتصدرين مع توصيات ذكية لتحسين الأداء.

## المتطلبات

- Python 3.11+
- بيئة افتراضية مفعلة

## التثبيت والتشغيل

```bash
pip install -r requirements.txt
uvicorn app.main:app --reload
```

سيعمل الخادم افتراضيًا على `http://127.0.0.1:8000` مع وثائق تلقائية عبر Swagger في `/docs`.

### كيفية استعراض البرنامج

> **ملاحظة:** لا يتضمن هذا المستودع واجهة أمامية. يتم التفاعل عبر واجهة برمجة التطبيقات (API) إما من خلال Swagger UI أو عبر أدوات مثل `curl` وPostman.

#### 1. تشغيل الخادم وفتح الوثائق

بعد تنفيذ أوامر التشغيل أعلاه:

- افتح المتصفح وتوجه إلى:
  - واجهة برمجة التطبيقات التفاعلية (Swagger UI): `http://127.0.0.1:8000/docs`
  - واجهة Redoc التوثيقية: `http://127.0.0.1:8000/redoc`
- من داخل Swagger UI اضغط زر **Authorize** أعلى اليمين لإضافة رمز الوصول (سيتم توليده في الخطوات اللاحقة) حتى تتمكن من تجربة نقاط النهاية المحمية.

#### 2. إنشاء الحساب الإداري الأول

يمكن إنشاء أول مستخدم (مثل المدير) عبر طلب `POST` إلى `/auth/register`.

مثال باستخدام `curl`:

```bash
curl -X POST http://127.0.0.1:8000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
        "email": "admin@example.com",
        "password": "ChangeMe123!",
        "full_name": "مدير النظام",
        "role": "admin"
      }'
```

يمكن تكرار العملية مع أدوار أخرى (`employee`, `supervisor`, `accountant`) لإنشاء بقية الحسابات. يقوم النظام آليًا بتهيئة ملفات التعريف الخاصة بالموظفين أو المشرفين عند الحاجة.

#### 3. تسجيل الدخول والحصول على رمز الوصول

بعد إنشاء الحساب، أرسل طلب `POST` إلى `/auth/token` باستخدام بيانات الاعتماد ذاتها للحصول على رمز JWT صالح لمدة ساعة افتراضيًا:

```bash
curl -X POST http://127.0.0.1:8000/auth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=ChangeMe123!"
```

سيعيد الخادم استجابة مشابهة للتالي:

```json
{
  "access_token": "<رمز طويل>",
  "token_type": "bearer"
}
```

انسخ قيمة `access_token` واستخدمها في Swagger UI عبر زر **Authorize** أو أضفها يدويًا في ترويسة الطلبات:

```
Authorization: Bearer <access_token>
```

#### 4. تجربة الوحدات المختلفة

مع تفعيل التفويض يمكنك الآن استعراض بقية النقاط:

- **المشاريع:** إنشاء مشروع جديد عبر `/projects/` ثم ربطه بالموظفين.
- **المهام:** إضافة المهام اليومية، تحديد الأولويات، وتسجيل الإيراد عبر `/tasks/logs/`.
- **لوحة المتصدرين والتحليلات:** قراءة نتائج `/analytics/leaderboard` و`/analytics/insights` لمتابعة الأداء اللحظي.
- **الحسابات:** تعديل الصلاحيات أو تعطيل المستخدمين من خلال `/users/{user_id}`.

كل نقطة نهاية موثقة داخل Swagger UI مع الحقول المطلوبة والاستجابة المتوقعة.

#### 5. توصيات للنشر أو العرض التجريبي

- لتقديم عرض توضيحي داخلي يمكنك إنشاء مجموعة حسابات اختبار ثم مشاركة روابط Swagger UI مع الفريق.
- في بيئة الإنتاج يفضل تشغيل الخادم باستخدام [Uvicorn مع Gunicorn](https://www.uvicorn.org/deployment/#gunicorn) أو أي مزود ASGI آخر، مع إعداد HTTPS وطبقة مصادقة خارجية إذا لزم الأمر.
- عند ربط واجهة أمامية لاحقًا، يمكنها استخدام نفس نقاط النهاية مع ترويسة التفويض المذكورة أعلاه.

### الإعداد مع Supabase

للاستفادة من قاعدة بيانات Supabase وخدماتها، عرِّف المتغيرات البيئية التالية قبل تشغيل الخادم:

```bash
export SUPABASE_URL="https://<project>.supabase.co"
export SUPABASE_SERVICE_ROLE_KEY="<service-role-key>"
export SUPABASE_DB_URL="postgresql+psycopg://<user>:<password>@db.<project>.supabase.co:5432/postgres"
```

- إذا كنت تفضّل استخدام مفتاح واجهة البرمجة العمومية فبإمكانك استخدام `SUPABASE_ANON_KEY` بدلًا من `SUPABASE_SERVICE_ROLE_KEY` وفقًا للصلاحيات المطلوبة.
- بمجرد توفر `SUPABASE_DB_URL` سيستخدم التطبيق قاعدة بيانات Supabase تلقائيًا، مع تفعيل اتصال آمن (`sslmode=require`).
- عند عدم تعريف القيم أعلاه سيستمر التطبيق في استخدام قاعدة بيانات SQLite المحلية (`tawq.db`).

## الاختبارات

```bash
pytest
```

> **ملاحظة:** في البيئات المغلقة قد يتعذر تنزيل الاعتماديات عبر `pip`. في هذه الحالة يجب توفير الحزم المطلوبة مسبقًا أو استخدام مرآة داخلية.

## لمحة عن الوظائف الرئيسية

- **نظام الصلاحيات:** حسابات للمدير، المشرف، المحاسب، والموظف مع تفعيل وتعطيل الحسابات.
- **إدارة المشاريع:** إنشاء المشاريع، تعيين الموظفين، وتتبع الإيرادات والمصروفات.
- **إدارة المهام:** إنشاء المهام، تعيين الأولويات، تسجيل السجلات اليومية، ورصد الإيرادات لكل مهمة.
- **لوحة المتصدرين:** نقاط، إيرادات، والمهام المكتملة مع توصيات ذكية مبنية على البيانات الحديثة.
- **رؤى الموظفين:** تحليلات أسبوعية للنشاط، العوائق المتكررة، والتوصيات الشخصية.

هذا الإصدار يمثل أساسًا يمكن توسيعه لاحقًا ليشمل بقية المتطلبات مثل الجدولة الذكية، الأتمتة، ونظام التدريب المتكامل.
